<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ïä§ÌÉÄ Î©îÏù¥Ïª§: Íµ≠Í∞Ä Ïó∞ÎåÄÍ∏∞</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #1a1a2e; font-family: 'Malgun Gothic', sans-serif; overflow: hidden; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        .panel { pointer-events: all; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; color: white; }
        #login-screen { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: #1a1a2e; z-index: 100; }
        .login-box { background: white; padding: 30px; border-radius: 15px; text-align: center; width: 280px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        input { padding: 12px; border-radius: 5px; border: 1px solid #ddd; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { padding: 12px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold; width: 100%; margin: 5px 0; }
        .btn-login { background: #2ecc71; color: white; }
        .btn-signup { background: #9b59b6; color: white; }
        #chat-area { position: absolute; bottom: 20px; left: 20px; width: 300px; }
        #messages { height: 100px; overflow-y: auto; font-size: 13px; margin-bottom: 5px; background: rgba(0,0,0,0.3); padding: 5px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2 style="color: #1a1a2e; margin-top: 0;">‚≠ê STAR MAKER</h2>
            <input type="text" id="uid" placeholder="ÏïÑÏù¥Îîî">
            <input type="password" id="upw" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏">
            <button class="btn-login" onclick="handleAuth('login')">Î°úÍ∑∏Ïù∏</button>
            <button class="btn-signup" onclick="handleAuth('signup')">ÌöåÏõêÍ∞ÄÏûÖ</button>
        </div>
    </div>

    <div id="ui-layer" class="hidden">
        <div id="status-bar" class="panel" style="position:absolute; top:20px; left:20px;">
            <div>üë§ Ïú†Ï†Ä: <span id="user-txt">-</span></div>
        </div>
        <div id="chat-area" class="panel">
            <div id="messages"></div>
            <input type="text" id="chat-input" placeholder="Î©îÏÑ∏ÏßÄ..." style="width: 70%;">
            <button onclick="sendChat()" style="width: 25%;">Ï†ÑÏÜ°</button>
        </div>
    </div>

    <script>
        // --- [Î≥¥ÎÇ¥Ï£ºÏã† ÏÑ§Ï†ïÍ∞í Ï†ÅÏö© Î∞è ÏàòÏ†ï] ---
        const firebaseConfig = {
            apiKey: "AIzaSyC2PE60dAZ-PD440QgploZuoLZckAg6FW0",
            authDomain: "star-edd2c.firebaseapp.com",
            databaseURL: "https://star-edd2c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "star-edd2c", // .firebaseapp.com Ï†úÍ±∞
            storageBucket: "star-edd2c.firebasestorage.app",
            appId: "1:724074828482:web:90001ae0ccdf0d389ce15b"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myId, myModel, scene, camera, renderer;
        let players = {};
        const keys = {};

        async function handleAuth(type) {
            const id = document.getElementById('uid').value;
            const pw = document.getElementById('upw').value;
            if(!id || !pw) return alert("ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî!");

            const userRef = db.ref('users/' + id);
            try {
                const snap = await userRef.once('value');
                if(type === 'signup') {
                    if(snap.exists()) return alert("Ïù¥ÎØ∏ ÏûàÎäî ÏïÑÏù¥ÎîîÏûÖÎãàÎã§.");
                    await userRef.set({ pw: pw, x: 0, z: 0 });
                    alert("ÌöåÏõêÍ∞ÄÏûÖ ÏÑ±Í≥µ! Î°úÍ∑∏Ïù∏ÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.");
                } else {
                    if(snap.exists() && snap.val().pw === pw) {
                        myId = id;
                        startGame();
                    } else {
                        alert("Ï†ïÎ≥¥Í∞Ä ÌãÄÎ†∏ÏäµÎãàÎã§.");
                    }
                }
            } catch(e) {
                console.error(e);
                alert("ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®! Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ RulesÍ∞Ä trueÏù∏ÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî.");
            }
        }

        function startGame() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('hidden');
            document.getElementById('user-txt').innerText = myId;
            init3D();
            syncData();
        }

        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0x27ae60 }));
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor, new THREE.GridHelper(100, 50));

            myModel = createHuman(0x3498db);
            scene.add(myModel);
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            camera.position.set(0, 5, 10);
            animate();
        }

        function createHuman(color) {
            const g = new THREE.Group();
            const b = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.8,0.3), new THREE.MeshStandardMaterial({color:color}));
            b.position.y = 0.4;
            const h = new THREE.Mesh(new THREE.BoxGeometry(0.4,0.4,0.4), new THREE.MeshStandardMaterial({color:0xffdbac}));
            h.position.y = 1.0;
            g.add(b, h);
            return g;
        }

        function syncData() {
            db.ref('live/' + myId).set({ x: 0, z: 0 });
            db.ref('live').on('value', s => {
                const d = s.val();
                for(let id in d) {
                    if(id === myId) continue;
                    if(!players[id]) { players[id] = createHuman(0xe74c3c); scene.add(players[id]); }
                    players[id].position.set(d[id].x, 0, d[id].z);
                }
            });
            db.ref('chats').limitToLast(10).on('child_added', s => {
                const c = s.val();
                document.getElementById('messages').innerHTML += `<div><b>${c.u}:</b> ${c.m}</div>`;
                document.getElementById('messages').scrollTop = 999;
            });
        }

        window.onkeydown = e => keys[e.code] = true;
        window.onkeyup = e => keys[e.code] = false;

        function animate() {
            requestAnimationFrame(animate);
            let m = false;
            if(keys['ArrowUp'] || keys['KeyW']) { myModel.position.z -= 0.1; m = true; }
            if(keys['ArrowDown'] || keys['KeyS']) { myModel.position.z += 0.1; m = true; }
            if(keys['ArrowLeft'] || keys['KeyA']) { myModel.position.x -= 0.1; m = true; }
            if(keys['ArrowRight'] || keys['KeyD']) { myModel.position.x += 0.1; m = true; }
            if(m) {
                db.ref('live/' + myId).update({ x: myModel.position.x, z: myModel.position.z });
                camera.position.lerp(new THREE.Vector3(myModel.position.x, 5, myModel.position.z + 7), 0.1);
                camera.lookAt(myModel.position);
            }
            renderer.render(scene, camera);
        }

        function sendChat() {
            const i = document.getElementById('chat-input');
            if(i.value) { db.ref('chats').push({ u: myId, m: i.value }); i.value = ""; }
        }
    </script>
</body>
</html>
