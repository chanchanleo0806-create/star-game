<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìŠ¤íƒ€ ë©”ì´ì»¤: êµ­ê°€ ì—°ëŒ€ê¸°</title>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #0f0f1a; color: white; font-family: 'Malgun Gothic', sans-serif; overflow: hidden; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .panel { pointer-events: all; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; border: 1px solid #444; }
        
        /* ë¡œê·¸ì¸ & ì„œë²„ ì„ íƒ */
        #login-screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #1a1a2e; z-index: 100; pointer-events: all; }
        
        /* ê²Œì„ UI */
        #status-bar { position: absolute; top: 20px; left: 20px; }
        #chat-area { position: absolute; bottom: 20px; left: 20px; width: 300px; }
        #messages { height: 150px; overflow-y: auto; font-size: 14px; background: rgba(0,0,0,0.5); margin-bottom: 5px; }
        #menu-buttons { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        input, button { padding: 8px; border-radius: 5px; border: none; }
        button { background: #00a8ff; color: white; cursor: pointer; font-weight: bold; }
        button:hover { background: #00d2ff; }
        .hidden { display: none !important; }
        .king-only { border: 2px solid gold; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h1>â­ STAR GAME ONLINE</h1>
        <div style="margin-bottom: 20px;">
            <input type="text" id="uid" placeholder="ì•„ì´ë””">
            <input type="password" id="upw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        </div>
        <div style="margin-bottom: 20px;">
            <select id="server-select" style="padding: 10px;">
                <option value="server_1">ì œ 1ì„œë²„ (ììœ ì§€ëŒ€)</option>
                <option value="server_2">ì œ 2ì„œë²„ (ì „ìŸí„°)</option>
            </select>
        </div>
        <div>
            <button onclick="signUp()">íšŒì›ê°€ì…</button>
            <button onclick="login()" style="background: #2ecc71;">ê²Œì„ ì…ì¥</button>
        </div>
    </div>

    <div id="ui-layer" class="hidden">
        <div id="status-bar" class="panel">
            <div>ğŸ“ ì„œë²„: <span id="cur-server-txt">-</span></div>
            <div>ğŸ›ï¸ êµ­ê°€: <span id="my-country-txt">ë¬´ì†Œì† (ë‚œë¯¼)</span></div>
            <div>ğŸ’° ìê¸ˆ: <span id="my-money-txt">0</span>ì›</div>
        </div>

        <div id="menu-buttons">
            <button onclick="openCountryMenu()">êµ­ê°€ ê´€ë¦¬/ì°½ì„¤</button>
            <button onclick="toggleVoice()">ğŸ¤ ìŒì„± ì±„íŒ…: <span id="voice-status">OFF</span></button>
        </div>

        <div id="chat-area" class="panel">
            <div id="messages"></div>
            <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." style="width: 200px;">
            <button onclick="sendChat()">ì „ì†¡</button>
        </div>
    </div>

    <script>
        // --- [ì„¤ì •: ë³¸ì¸ì˜ íŒŒì´ì–´ë² ì´ìŠ¤ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”] ---
        const firebaseConfig = {
            apiKey: "AIzaSyC2PE60dAZ-PD440QgploZuoLZckAg6FW0",
            databaseURL: "https://star-edd2c-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "star-edd2c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myId, myCountry = null, currentServer = "server_1";
        let scene, camera, renderer, myModel;
        const players = {};

        // --- [íšŒì›ê°€ì… & ë¡œê·¸ì¸] ---
        function signUp() {
            const id = document.getElementById('uid').value;
            const pw = document.getElementById('upw').value;
            if(!id || !pw) return alert("ì•„ì´ë””/ë¹„ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”!");
            db.ref('global_users/' + id).set({ pw: pw, money: 1000 }).then(() => alert("ê°€ì… ì™„ë£Œ!"));
        }

        function login() {
            const id = document.getElementById('uid').value;
            const pw = document.getElementById('upw').value;
            currentServer = document.getElementById('server-select').value;

            db.ref('global_users/' + id).once('value', (snap) => {
                const data = snap.val();
                if(data && data.pw === pw) {
                    myId = id;
                    startGameloop();
                } else {
                    alert("ì •ë³´ê°€ í‹€ë¦½ë‹ˆë‹¤!");
                }
            });
        }

        function startGameloop() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('hidden');
            document.getElementById('cur-server-txt').innerText = currentServer;
            
            init3D();
            syncServer();
            initVoice();
        }

        // --- [3D ì›”ë“œ ì„¤ì •] ---
        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a12);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // ë‚´ ìºë¦­í„°
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
            myModel = new THREE.Mesh(geometry, material);
            scene.add(myModel);

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const sun = new THREE.DirectionalLight(0xffffff, 0.5);
            sun.position.set(5, 10, 7);
            scene.add(sun);

            camera.position.set(0, 5, 10);
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            move();
            renderer.render(scene, camera);
        }

        // --- [ë„¤íŠ¸ì›Œí¬ ë™ê¸°í™”] ---
        function syncServer() {
            // ìœ„ì¹˜ ê³µìœ 
            db.ref(`${currentServer}/players`).on('value', (snap) => {
                const data = snap.val();
                for(let id in data) {
                    if(id === myId) continue;
                    if(!players[id]) {
                        players[id] = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color: 0xff4444}));
                        scene.add(players[id]);
                    }
                    players[id].position.set(data[id].x, 0, data[id].z);
                }
            });

            // ë‚´ êµ­ê°€ ì •ë³´ í™•ì¸
            db.ref(`${currentServer}/memberships/${myId}`).on('value', (snap) => {
                if(snap.exists()) {
                    myCountry = snap.val().countryId;
                    document.getElementById('my-country-txt').innerText = myCountry;
                }
            });
        }

        // --- [ì´ë™ ë¡œì§] ---
        const keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        function move() {
            let moved = false;
            if(keys['ArrowUp'] || keys['KeyW']) { myModel.position.z -= 0.1; moved = true; }
            if(keys['ArrowDown'] || keys['KeyS']) { myModel.position.z += 0.1; moved = true; }
            if(keys['ArrowLeft'] || keys['KeyA']) { myModel.position.x -= 0.1; moved = true; }
            if(keys['ArrowRight'] || keys['KeyD']) { myModel.position.x += 0.1; moved = true; }

            if(moved) {
                db.ref(`${currentServer}/players/${myId}`).set({ x: myModel.position.x, z: myModel.position.z });
                camera.position.lerp(new THREE.Vector3(myModel.position.x, 5, myModel.position.z + 7), 0.1);
                camera.lookAt(myModel.position);
            }
        }

        // --- [êµ­ê°€ ì‹œìŠ¤í…œ: ì‹ ì²­ ë° ìŠ¹ì¸] ---
        function openCountryMenu() {
            const name = prompt("ë‚˜ë¼ ì´ë¦„ì„ ì…ë ¥í•˜ê±°ë‚˜ ê°€ì…í•  ë‚˜ë¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
            const type = prompt("ì²´ì œ ì„ íƒ (ììœ  / ê³µì‚° / ë™ë§¹)");
            
            if(confirm(`${name} ë‚˜ë¼ì— ê°€ì… ì‹ ì²­(ë˜ëŠ” ì°½ì„¤)í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                // ì…êµ­ ì‹¬ì‚¬ ìš”ì²­ ê¸°ë¡
                db.ref(`${currentServer}/requests/${name}/${myId}`).set({
                    id: myId,
                    type: type,
                    status: "PENDING"
                });
                alert("ì‹ ì²­ ì™„ë£Œ! ì™•ì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”.");
            }
        }

        // --- [ìŒì„± ì±„íŒ… ê¸°ì´ˆ] ---
        let myPeer;
        function initVoice() {
            myPeer = new Peer(myId);
            myPeer.on('call', call => {
                navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
                    call.answer(stream);
                    call.on('stream', remoteStream => {
                        const audio = document.createElement('audio');
                        audio.srcObject = remoteStream;
                        audio.play();
                    });
                });
            });
        }
        
        function toggleVoice() {
            alert("ê°€ê¹Œìš´ ìœ ì €ì™€ ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤...");
            // ì‹¤ì œ êµ¬í˜„ ì‹œ ì£¼ë³€ ìœ ì € ì•„ì´ë””ë¥¼ ì°¾ì•„ connect() í˜¸ì¶œ
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            db.ref(`${currentServer}/chats`).push({ user: myId, msg: input.value });
            input.value = "";
        }

        db.ref(`${currentServer}/chats`).limitToLast(10).on('child_added', (snap) => {
            const d = snap.val();
            document.getElementById('messages').innerHTML += `<div><b>${d.user}:</b> ${d.msg}</div>`;
        });

    </script>
</body>
</html>