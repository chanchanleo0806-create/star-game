<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>STAR MAKER: 3D MASTER</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Arial', sans-serif; }
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; color: white; }
        .panel { pointer-events: all; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; margin: 10px; border: 2px solid #555; }
        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #00ff00; font-size: 24px; }
        button { cursor: pointer; background: #444; color: white; border: 1px solid #777; padding: 10px; border-radius: 5px; }
        .hidden { display: none !important; }
        #hp-bar { width: 100%; height: 10px; background: #333; border-radius: 5px; margin-top: 5px; }
        #hp-fill { width: 100%; height: 100%; background: #ff4757; border-radius: 5px; transition: 0.3s; }
        #guide { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; background: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; }
    </style>
</head>
<body>

<div id="login-screen" style="position:fixed; inset:0; background:#1a1a2e; z-index:100; display:flex; align-items:center; justify-content:center;">
    <div class="panel" style="width:300px; text-align:center; background:white; color:black;">
        <h2 style="color:#1a1a2e">â›ï¸ STAR MAKER 3D</h2>
        <input type="text" id="uid" placeholder="ì•„ì´ë””" style="width:90%; padding:10px; margin-bottom:10px;">
        <input type="password" id="upw" placeholder="ë¹„ë°€ë²ˆí˜¸" style="width:90%; padding:10px; margin-bottom:20px;">
        <button onclick="handleAuth('login')" style="width:45%; background:#2ecc71">ë¡œê·¸ì¸</button>
        <button onclick="handleAuth('signup')" style="width:45%; background:#9b59b6">ê°€ì…</button>
    </div>
</div>

<div id="ui" class="hidden">
    <div id="guide">í™”ë©´ì„ í´ë¦­í•˜ë©´ ì‹œì ì´ ê³ ì •ë©ë‹ˆë‹¤ (ESCë¡œ í•´ì œ)</div>
    <div id="crosshair">+</div>
    
    <div class="panel" style="width: 220px;">
        <div style="font-size: 1.2em; color: #f1c40f;">ğŸ’° <span id="money-txt">0</span> G</div>
        <div id="hp-bar"><div id="hp-fill"></div></div>
        <div style="font-size: 12px; margin-top: 8px;">
            ğŸªµ:<span id="inv-WOOD">0</span> ğŸª¨:<span id="inv-STONE">0</span> ğŸ’:<span id="inv-DIAMOND">0</span>
        </div>
        <div style="margin-top:5px; color:#3498db; font-size:14px;">âš”ï¸ <span id="weapon-txt">ë§¨ì†</span></div>
    </div>

    <div id="craft-ui" class="panel hidden" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:250px;">
        <h3 style="margin:0 0 10px 0">âš’ï¸ ì œì‘ëŒ€</h3>
        <button onclick="craft('IRON_SWORD', 500)" style="width:100%; margin-bottom:5px;">ì²  ê²€ (500G)</button>
        <button onclick="craft('DIAMOND_SWORD', 2000)" style="width:100%; margin-bottom:5px;">ë‹¤ì´ì•„ ê²€ (2000G)</button>
        <button onclick="toggleCraft()" style="width:100%; background:#e74c3c">ë‹«ê¸°</button>
    </div>

    <div style="position:fixed; bottom:20px; left:20px; pointer-events:all; display:flex; gap:10px;">
        <button onclick="toggleCraft()" style="background:#e67e22">âš’ï¸ ì œì‘ëŒ€</button>
        <button onclick="jump()">ğŸš€ JUMP (Space)</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC2PE60dAZ-PD440QgploZuoLZckAg6FW0",
        authDomain: "star-edd2c.firebaseapp.com",
        databaseURL: "https://star-edd2c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "star-edd2c",
        storageBucket: "star-edd2c.firebasestorage.app",
        appId: "1:724074828482:web:90001ae0ccdf0d389ce15b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId, myModel, scene, camera, renderer, myData = {};
    let chunks = {}, players = {}, blocks = [];
    const keys = {}, CHUNK_SIZE = 14, NOISE_SCALE = 0.08, HEIGHT_SCALE = 4;
    let vY = 0, rotY = 0;

    const BIOMES = { WATER: 0x3498db, SAND: 0xf1c40f, GRASS: 0x2ecc71, STONE: 0x7f8c8d, SNOW: 0xffffff };

    async function handleAuth(type) {
        const id = document.getElementById('uid').value;
        const pw = document.getElementById('upw').value;
        const ref = db.ref('users/' + id);
        const snap = await ref.once('value');
        if(type === 'signup') {
            if(snap.exists()) return alert("ì¤‘ë³µ ì•„ì´ë””");
            await ref.set({pw, WOOD:0, STONE:0, DIAMOND:0, hp:100, weapon:"ë§¨ì†", money:500});
            alert("ê°€ì… ì„±ê³µ!");
        } else {
            if(snap.exists() && snap.val().pw === pw) { myId = id; start(); }
            else alert("ì˜¤ë¥˜");
        }
    }

    function start() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('ui').classList.remove('hidden');
        init3D();
        sync();
    }

    function init3D() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        myModel = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1, 0.5), new THREE.MeshStandardMaterial({color: 0x3498db}));
        body.position.y = 1;
        myModel.add(body);
        scene.add(myModel);

        scene.add(new THREE.DirectionalLight(0xffffff, 1), new THREE.AmbientLight(0xffffff, 0.5));
        
        // ë§ˆìš°ìŠ¤ ì‹œì  ê³ ì • ë¡œì§
        renderer.domElement.addEventListener('click', () => {
            renderer.domElement.requestPointerLock();
            document.getElementById('guide').style.display = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (document.pointerLockElement === renderer.domElement) {
                myModel.rotation.y -= e.movementX * 0.003;
            }
        });

        window.addEventListener('mousedown', onAction);
        animate();
    }

    function getTerrainHeight(x, z) {
        return Math.floor(Math.sin(x * NOISE_SCALE) * Math.cos(z * NOISE_SCALE) * HEIGHT_SCALE);
    }

    function updateChunks() {
        const cx = Math.floor(myModel.position.x / CHUNK_SIZE);
        const cz = Math.floor(myModel.position.z / CHUNK_SIZE);
        for(let x = cx-1; x <= cx+1; x++) {
            for(let z = cz-1; z <= cz+1; z++) {
                if(!chunks[`${x},${z}`]) {
                    const group = new THREE.Group();
                    for(let lx=0; lx<CHUNK_SIZE; lx++){
                        for(let lz=0; lz<CHUNK_SIZE; lz++){
                            const wx = x*CHUNK_SIZE + lx, wz = z*CHUNK_SIZE + lz;
                            const h = getTerrainHeight(wx, wz);
                            const box = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({
                                color: h < -1 ? BIOMES.WATER : h < 0 ? BIOMES.SAND : h < 2 ? BIOMES.GRASS : h < 4 ? BIOMES.STONE : BIOMES.SNOW,
                                flatShading: true
                            }));
                            box.position.set(wx, h - 0.5, wz);
                            box.userData = {type: h > 2 ? 'STONE' : 'WOOD'};
                            group.add(box);
                            blocks.push(box);
                        }
                    }
                    scene.add(group);
                    chunks[`${x},${z}`] = group;
                }
            }
        }
    }

    function onAction() {
        const ray = new THREE.Raycaster();
        ray.setFromCamera(new THREE.Vector2(0,0), camera);
        const hits = ray.intersectObjects(blocks);
        if(hits.length > 0 && hits[0].distance < 6) {
            const type = hits[0].object.userData.type;
            db.ref('users/'+myId).transaction(d => {
                if(d) { d[type] = (d[type]||0)+1; d.money = (d.money||0)+30; }
                return d;
            });
            hits[0].object.visible = false;
        }
    }

    function toggleCraft() { document.getElementById('craft-ui').classList.toggle('hidden'); }
    function craft(item, price) {
        if(myData.money < price) return alert("ëˆ ë¶€ì¡±!");
        db.ref('users/'+myId).update({ money: myData.money - price, weapon: item });
        alert(item + " ì œì‘!");
    }
    function jump() { if(vY === 0) vY = 0.22; }

    function sync() {
        db.ref('users/'+myId).on('value', s => {
            myData = s.val() || {};
            ['WOOD','STONE','DIAMOND'].forEach(k => document.getElementById('inv-'+k).innerText = myData[k]||0);
            document.getElementById('money-txt').innerText = myData.money || 0;
            document.getElementById('weapon-txt').innerText = myData.weapon || "ë§¨ì†";
            document.getElementById('hp-fill').style.width = (myData.hp || 100) + "%";
        });
        db.ref('live/'+myId).set({x:0, y:0, z:0, rot:0});
        db.ref('live').on('value', s => {
            const d = s.val();
            for(let id in d) {
                if(id === myId) continue;
                if(!players[id]) {
                    players[id] = new THREE.Mesh(new THREE.BoxGeometry(0.5,1,0.5), new THREE.MeshStandardMaterial({color:0xe74c3c}));
                    scene.add(players[id]);
                }
                players[id].position.set(d[id].x, d[id].y + 0.5, d[id].z);
                players[id].rotation.y = d[id].rot;
            }
        });
    }

    window.onkeydown = e => { keys[e.code] = true; if(e.code === 'Space') jump(); };
    window.onkeyup = e => keys[e.code] = false;

    function animate() {
        requestAnimationFrame(animate);
        
        // ë°©í–¥ ê¸°ë°˜ ì´ë™
        const moveSpeed = 0.15;
        const dir = new THREE.Vector3();
        myModel.getWorldDirection(dir);
        
        if(keys['KeyW']) myModel.position.addScaledVector(dir, moveSpeed);
        if(keys['KeyS']) myModel.position.addScaledVector(dir, -moveSpeed);
        
        const sideDir = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), dir);
        if(keys['KeyA']) myModel.position.addScaledVector(sideDir, moveSpeed);
        if(keys['KeyD']) myModel.position.addScaledVector(sideDir, -moveSpeed);

        const groundY = getTerrainHeight(myModel.position.x, myModel.position.z);
        if(myModel.position.y > groundY) vY -= 0.012;
        else { myModel.position.y = groundY; vY = Math.max(0, vY); }
        myModel.position.y += vY;

        updateChunks();
        db.ref('live/'+myId).update({x: myModel.position.x, y: myModel.position.y, z: myModel.position.z, rot: myModel.rotation.y});
        
        // ì¹´ë©”ë¼ ì‹œì : ìºë¦­í„° ë’¤ìª½ ìƒë‹¨
        const camOffset = new THREE.Vector3(0, 4, 8).applyMatrix4(myModel.matrixWorld);
        camera.position.lerp(camOffset, 0.1);
        camera.lookAt(myModel.position.x, myModel.position.y + 1, myModel.position.z);
        
        renderer.render(scene, camera);
    }
</script>
</body>
</html>
