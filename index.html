<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STAR MAKER: ULTIMATE</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Arial', sans-serif; touch-action: none; }
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; color: white; }
        .panel { pointer-events: all; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; margin: 10px; border: 1px solid #00ffff; }
        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #0f0; font-size: 24px; pointer-events: none; }
        button { cursor: pointer; background: #333; color: white; border: 1px solid #555; padding: 10px; border-radius: 5px; font-weight: bold; }
        .hidden { display: none !important; }
        #hp-bar { width: 100%; height: 10px; background: #222; margin-top: 5px; border-radius: 5px; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #ff4757; transition: 0.3s; }
        
        /* ÌÑ∞Ïπò Ïª®Ìä∏Î°§ */
        #joystick-zone { position: fixed; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: all; border: 2px solid rgba(255,255,255,0.3); }
        #joystick-stick { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.5; }
        #action-buttons { position: fixed; bottom: 40px; right: 40px; pointer-events: all; display: flex; flex-direction: column; gap: 10px; }
        .btn-round { width: 70px; height: 70px; border-radius: 50%; background: rgba(0,255,255,0.2); border: 2px solid #00ffff; color: white; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body>

<div id="login-screen" style="position:fixed; inset:0; background:#111; z-index:100; display:flex; align-items:center; justify-content:center;">
    <div class="panel" style="width:280px; text-align:center;">
        <h2 style="color:#00ffff; margin-bottom:20px;">MINE WORLD VR</h2>
        <input type="text" id="uid" placeholder="ÏïÑÏù¥Îîî" style="width:90%; padding:10px; margin-bottom:10px; background:#222; color:#fff; border:1px solid #444;">
        <input type="password" id="upw" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" style="width:90%; padding:10px; margin-bottom:20px; background:#222; color:#fff; border:1px solid #444;">
        <div style="display:flex; justify-content:space-between;">
            <button onclick="handleAuth('login')" style="width:48%; background:#00ffff; color:#000;">Î°úÍ∑∏Ïù∏</button>
            <button onclick="handleAuth('signup')" style="width:48%; background:#9b59b6;">ÌöåÏõêÍ∞ÄÏûÖ</button>
        </div>
    </div>
</div>

<div id="ui" class="hidden">
    <div id="crosshair">+</div>
    <div class="panel" style="width: 200px;">
        <div style="color:#f1c40f;">üí∞ <span id="money-txt">0</span> G</div>
        <div id="hp-bar"><div id="hp-fill"></div></div>
        <div style="font-size:12px; margin-top:8px;">ü™µ:<span id="inv-WOOD">0</span> ü™®:<span id="inv-STONE">0</span> üíé:<span id="inv-DIAMOND">0</span></div>
        <div style="margin-top:5px; font-size:12px; color:#3498db;">‚öîÔ∏è <span id="weapon-txt">Îß®ÏÜê</span></div>
    </div>

    <div id="craft-ui" class="panel hidden" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); width:250px;">
        <h3 style="margin-top:0;">‚öíÔ∏è Ï†úÏûëÎåÄ</h3>
        <button onclick="craft('IRON_SWORD', 500)" style="width:100%; margin-bottom:5px;">Ï≤† Í≤Ä (500G)</button>
        <button onclick="craft('DIAMOND_SWORD', 2000)" style="width:100%;">Îã§Ïù¥ÏïÑ Í≤Ä (2000G)</button>
        <button onclick="toggleCraft()" style="width:100%; margin-top:10px; background:#e74c3c;">Îã´Í∏∞</button>
    </div>

    <div id="joystick-zone"><div id="joystick-stick"></div></div>
    <div id="action-buttons">
        <button class="btn-round" onclick="jump()">JUMP</button>
        <button class="btn-round" style="background:rgba(255,0,0,0.3);" onclick="onAction()">MINE</button>
        <button class="btn-round" style="background:#e67e22;" onclick="toggleCraft()">CRAFT</button>
    </div>
</div>

<script>
    // 1. Firebase ÏÑ§Ï†ï
    const firebaseConfig = {
        apiKey: "AIzaSyC2PE60dAZ-PD440QgploZuoLZckAg6FW0",
        authDomain: "star-edd2c.firebaseapp.com",
        databaseURL: "https://star-edd2c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "star-edd2c",
        storageBucket: "star-edd2c.firebasestorage.app",
        appId: "1:724074828482:web:90001ae0ccdf0d389ce15b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. Î≥ÄÏàò ÏÑ§Ï†ï
    let myId, myModel, scene, camera, renderer, myData = {};
    let chunks = {}, players = {}, blocks = [];
    const keys = {}, CHUNK_SIZE = 12, NOISE_SCALE = 0.08, HEIGHT_SCALE = 4;
    let vY = 0, touchX = 0, touchY = 0;

    // 3. Î°úÍ∑∏Ïù∏/Í∞ÄÏûÖ Î°úÏßÅ
    async function handleAuth(type) {
        const id = document.getElementById('uid').value.trim();
        const pw = document.getElementById('upw').value.trim();
        if(!id || !pw) return alert("ÏûÖÎ†•Ïπ∏ÏùÑ Ï±ÑÏõåÏ£ºÏÑ∏Ïöî!");

        try {
            const ref = db.ref('users/' + id);
            const snap = await ref.once('value');
            if(type === 'signup') {
                if(snap.exists()) return alert("Ïù¥ÎØ∏ ÏûàÎäî ÏïÑÏù¥Îîî!");
                await ref.set({pw, WOOD:0, STONE:0, DIAMOND:0, hp:100, weapon:"Îß®ÏÜê", money:1000});
                alert("Í∞ÄÏûÖ ÏÑ±Í≥µ! Î°úÍ∑∏Ïù∏ Ìï¥Ï£ºÏÑ∏Ïöî.");
            } else {
                if(snap.exists() && snap.val().pw === pw) { myId = id; start(); }
                else alert("ÏïÑÏù¥Îîî/ÎπÑÎ≤à ÌôïÏù∏!");
            }
        } catch(e) { alert("ÏÑúÎ≤Ñ Ïò§Î•ò! Í∑úÏπô ÏÑ§Ï†ïÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî."); }
    }

    // 4. Í≤åÏûÑ ÏãúÏûë Î∞è 3D Ï¥àÍ∏∞Ìôî
    function start() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('ui').classList.remove('hidden');
        init3D();
        sync();
    }

    function init3D() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        myModel = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1, 0.5), new THREE.MeshStandardMaterial({color: 0x00ffff}));
        body.position.y = 1;
        myModel.add(body);
        scene.add(myModel);

        scene.add(new THREE.DirectionalLight(0xffffff, 1), new THREE.AmbientLight(0xffffff, 0.5));

        // PC ÎßàÏö∞Ïä§ ÌöåÏ†Ñ
        renderer.domElement.addEventListener('click', () => renderer.domElement.requestPointerLock());
        document.addEventListener('mousemove', (e) => {
            if (document.pointerLockElement === renderer.domElement) myModel.rotation.y -= e.movementX * 0.003;
        });

        // Î™®Î∞îÏùº Ï°∞Ïù¥Ïä§Ìã±
        const zone = document.getElementById('joystick-zone');
        const stick = document.getElementById('joystick-stick');
        zone.addEventListener('touchmove', (e) => {
            const rect = zone.getBoundingClientRect();
            const cx = rect.left + rect.width/2, cy = rect.top + rect.height/2;
            let dx = e.touches[0].clientX - cx, dy = e.touches[0].clientY - cy;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist > 40) { dx *= 40/dist; dy *= 40/dist; }
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            touchX = dx/40; touchY = dy/40;
        });
        zone.addEventListener('touchend', () => { stick.style.transform = 'translate(0,0)'; touchX = 0; touchY = 0; });

        animate();
    }

    // 5. ÏßÄÌòï ÏÉùÏÑ± Î∞è Ï∂©Îèå
    function getTerrainHeight(x, z) {
        return Math.floor(Math.sin(x * NOISE_SCALE) * Math.cos(z * NOISE_SCALE) * HEIGHT_SCALE);
    }

    function updateChunks() {
        const cx = Math.floor(myModel.position.x / CHUNK_SIZE);
        const cz = Math.floor(myModel.position.z / CHUNK_SIZE);
        for(let x = cx-1; x <= cx+1; x++) {
            for(let z = cz-1; z <= cz+1; z++) {
                if(!chunks[`${x},${z}`]) {
                    const group = new THREE.Group();
                    for(let lx=0; lx<CHUNK_SIZE; lx++){
                        for(let lz=0; lz<CHUNK_SIZE; lz++){
                            const wx = x*CHUNK_SIZE + lx, wz = z*CHUNK_SIZE + lz;
                            const h = getTerrainHeight(wx, wz);
                            const color = h < 0 ? 0xf1c40f : h < 2 ? 0x2ecc71 : 0x7f8c8d;
                            const box = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({color, flatShading: true}));
                            box.position.set(wx, h - 0.5, wz);
                            box.userData = {type: h > 2 ? 'STONE' : 'WOOD'};
                            group.add(box); blocks.push(box);
                        }
                    }
                    scene.add(group); chunks[`${x},${z}`] = group;
                }
            }
        }
    }

    // 6. ÌñâÎèô Î°úÏßÅ
    function onAction() {
        const ray = new THREE.Raycaster();
        ray.setFromCamera(new THREE.Vector2(0,0), camera);
        const hits = ray.intersectObjects(blocks);
        if(hits.length > 0 && hits[0].distance < 6) {
            const type = hits[0].object.userData.type;
            db.ref('users/'+myId).transaction(d => {
                if(d) { d[type] = (d[type]||0)+1; d.money = (d.money||0)+30; }
                return d;
            });
            hits[0].object.visible = false;
        }
    }

    function toggleCraft() { document.getElementById('craft-ui').classList.toggle('hidden'); }
    function craft(item, price) {
        if(myData.money < price) return alert("Îèà Î∂ÄÏ°±!");
        db.ref('users/'+myId).update({ money: myData.money - price, weapon: item });
        alert(item + " ÏôÑÎ£å!");
    }
    function jump() { if(vY === 0) vY = 0.23; }

    function sync() {
        db.ref('users/'+myId).on('value', s => {
            myData = s.val() || {};
            ['WOOD','STONE','DIAMOND'].forEach(k => document.getElementById('inv-'+k).innerText = myData[k]||0);
            document.getElementById('money-txt').innerText = myData.money || 0;
            document.getElementById('weapon-txt').innerText = myData.weapon || "Îß®ÏÜê";
            document.getElementById('hp-fill').style.width = (myData.hp || 100) + "%";
        });
        db.ref('live/'+myId).set({x:0, y:0, z:0, rot:0});
        db.ref('live').on('value', s => {
            const d = s.val();
            for(let id in d) {
                if(id === myId) continue;
                if(!players[id]) {
                    players[id] = new THREE.Mesh(new THREE.BoxGeometry(0.5,1,0.5), new THREE.MeshStandardMaterial({color:0xff4757}));
                    scene.add(players[id]);
                }
                players[id].position.set(d[id].x, d[id].y + 0.5, d[id].z);
                players[id].rotation.y = d[id].rot;
            }
        });
    }

    window.onkeydown = e => { keys[e.code] = true; if(e.code === 'Space') jump(); };
    window.onkeyup = e => keys[e.code] = false;

    // 7. Î©îÏù∏ Î£®ÌîÑ
    function animate() {
        requestAnimationFrame(animate);
        const speed = 0.15;
        const dir = new THREE.Vector3();
        myModel.getWorldDirection(dir);
        const side = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), dir);

        // ÌÇ§Î≥¥Îìú & ÌÑ∞Ïπò Ïù¥Îèô ÌÜµÌï©
        if(keys['KeyW'] || touchY < -0.3) myModel.position.addScaledVector(dir, speed);
        if(keys['KeyS'] || touchY > 0.3) myModel.position.addScaledVector(dir, -speed);
        if(keys['KeyA'] || touchX < -0.3) myModel.position.addScaledVector(side, speed);
        if(keys['KeyD'] || touchX > 0.3) myModel.position.addScaledVector(side, -speed);

        // Ï§ëÎ†•/Ï∂©Îèå
        const groundY = getTerrainHeight(myModel.position.x, myModel.position.z);
        if(myModel.position.y > groundY) vY -= 0.012;
        else { myModel.position.y = groundY; vY = Math.max(0, vY); }
        myModel.position.y += vY;

        updateChunks();
        db.ref('live/'+myId).update({x: myModel.position.x, y: myModel.position.y, z: myModel.position.z, rot: myModel.rotation.y});
        
        const camPos = new THREE.Vector3(0, 4, 8).applyMatrix4(myModel.matrixWorld);
        camera.position.lerp(camPos, 0.1);
        camera.lookAt(myModel.position.x, myModel.position.y + 1, myModel.position.z);
        renderer.render(scene, camera);
    }
</script>
</body>
</html>
