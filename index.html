<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤íƒ€ ë©”ì´ì»¤: êµ­ê°€ ì—°ëŒ€ê¸°</title>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #87CEEB; color: white; font-family: 'Malgun Gothic', sans-serif; overflow: hidden; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .panel { pointer-events: all; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; border: 1px solid #444; }
        
        /* ë¡œê·¸ì¸ í™”ë©´ */
        #login-screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(26, 26, 46, 0.9); z-index: 100; pointer-events: all; }
        .login-box { background: white; padding: 30px; border-radius: 15px; color: #333; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        
        /* ìƒë‹¨ ìƒíƒœë°” */
        #status-bar { position: absolute; top: 20px; left: 20px; color: white; }
        
        /* ì±„íŒ…ì°½ */
        #chat-area { position: absolute; bottom: 20px; left: 20px; width: 300px; }
        #messages { height: 120px; overflow-y: auto; font-size: 13px; background: rgba(0,0,0,0.3); margin-bottom: 5px; padding: 5px; }
        
        /* ìš°ì¸¡ ë©”ë‰´ */
        #menu-buttons { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        input, button { padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin: 5px; }
        button { background: #3498db; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:hover { background: #2980b9; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color: #1a1a2e; margin-bottom: 10px;">â­ STAR MAKER</h1>
            <p>ì„œë²„ë¥¼ ì„ íƒí•˜ê³  ì…ì¥í•˜ì„¸ìš”</p>
            <input type="text" id="uid" placeholder="ë‹‰ë„¤ì„ ì…ë ¥"><br>
            <select id="server-select" style="width: 100%; height: 40px;">
                <option value="server_1">ì œ 1ì„œë²„ (í‰í™”ì§€ëŒ€)</option>
                <option value="server_2">ì œ 2ì„œë²„ (ì „ìŸì§€ëŒ€)</option>
            </select><br>
            <button onclick="login()" style="width: 100%; background: #2ecc71;">ê²Œì„ ì‹œì‘</button>
        </div>
    </div>

    <div id="ui-layer" class="hidden">
        <div id="status-bar" class="panel">
            <div>ğŸŒ ì„œë²„: <span id="cur-server-txt">-</span></div>
            <div>ğŸ›ï¸ êµ­ê°€: <span id="my-country-txt">ë¬´ì†Œì†</span></div>
        </div>

        <div id="menu-buttons">
            <button onclick="createCountry()">ğŸš© êµ­ê°€ ì°½ì„¤/ê°€ì…</button>
        </div>

        <div id="chat-area" class="panel">
            <div id="messages"></div>
            <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€..." style="width: 180px;">
            <button onclick="sendChat()">ì „ì†¡</button>
        </div>
    </div>

    <script>
        // --- [Firebase ì„¤ì •: ë³¸ì¸ì˜ í‚¤ë¡œ ê¼­ ë°”ê¾¸ì„¸ìš”!] ---
        const firebaseConfig = {
            apiKey: "AIzaSyC2PE60dAZ-PD440QgploZuoLZckAg6FW0",
            databaseURL: "https://star-edd2c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "star-edd2c"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myId, currentServer, myModel, scene, camera, renderer;
        let players = {};
        const keys = {};

        // --- [ë¡œê·¸ì¸ ë° ì‹œì‘] ---
        // 1. íšŒì›ê°€ì… í•¨ìˆ˜
function signUp() {
    const id = document.getElementById('uid').value;
    const pw = prompt("ì‚¬ìš©í•  ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:"); // ì‹¤ì œë¡œëŠ” ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½ì„ ë§Œë“œëŠ” ê²Œ ì¢‹ìŒ

    if(!id || !pw) return alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”!");

    // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì¸ì§€ í™•ì¸
    db.ref('users/' + id).once('value', (snap) => {
        if(snap.exists()) {
            alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤!");
        } else {
            // ìƒˆ ìœ ì € ì •ë³´ ì €ì¥ (ì´ˆê¸° ìê¸ˆ 1000ì› ì¶”ê°€)
            db.ref('users/' + id).set({
                pw: pw,
                money: 1000,
                country: "ë¬´ì†Œì†"
            }).then(() => {
                alert("íšŒì›ê°€ì… ì„±ê³µ! ì´ì œ ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”.");
            });
        }
    });
}

// 2. ë¡œê·¸ì¸ í•¨ìˆ˜ (ìˆ˜ì •ë³¸)
function login() {
    const id = document.getElementById('uid').value;
    const pw = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
    currentServer = document.getElementById('server-select').value;

    db.ref('users/' + id).once('value', (snap) => {
        const userData = snap.val();
        if(userData && userData.pw === pw) {
            myId = id;
            // ê²Œì„ í™”ë©´ìœ¼ë¡œ ì „í™˜
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('hidden');
            init3D();
            syncData();
        } else {
            alert("ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!");
        }
    });
}

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('hidden');
            document.getElementById('cur-server-txt').innerText = currentServer;

            init3D();
            syncData();
        }

        // --- [3D ì›”ë“œ êµ¬ì„±] ---
        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); // í•˜ëŠ˜ìƒ‰

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // ì”ë”” ë°”ë‹¥
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(100, 100),
                new THREE.MeshStandardMaterial({ color: 0x27ae60 })
            );
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // ê°€ì´ë“œ ê²©ì
            scene.add(new THREE.GridHelper(100, 50, 0x000000, 0x000000));

            // ë‚´ ìºë¦­í„° (ì‚¬ëŒ í˜•íƒœ)
            myModel = createHuman(0x3498db);
            scene.add(myModel);

            // ì¡°ëª…
            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const sun = new THREE.DirectionalLight(0xffffff, 0.5);
            sun.position.set(10, 20, 10);
            scene.add(sun);

            camera.position.set(0, 5, 10);
            animate();
        }

        function createHuman(color) {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.8, 0.3), new THREE.MeshStandardMaterial({color: color}));
            body.position.y = 0.4;
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), new THREE.MeshStandardMaterial({color: 0xffdbac}));
            head.position.y = 1.0;
            group.add(body, head);
            return group;
        }

        // --- [ì‹¤ì‹œê°„ ë°ì´í„° ë™ê¸°í™”] ---
        function syncData() {
            // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            db.ref(`${currentServer}/players/${myId}`).set({ x: 0, z: 0 });
            db.ref(`${currentServer}/players`).on('value', (snap) => {
                const data = snap.val();
                for(let id in data) {
                    if(id === myId) continue;
                    if(!players[id]) {
                        players[id] = createHuman(0xe74c3c);
                        scene.add(players[id]);
                    }
                    players[id].position.set(data[id].x, 0, data[id].z);
                }
            });

            // ì±„íŒ… ìˆ˜ì‹ 
            db.ref(`${currentServer}/chats`).limitToLast(10).on('child_added', (snap) => {
                const chat = snap.val();
                const msgDiv = document.getElementById('messages');
                msgDiv.innerHTML += `<div><b>${chat.user}:</b> ${chat.msg}</div>`;
                msgDiv.scrollTop = msgDiv.scrollHeight;
            });
        }

        // --- [ì¡°ì‘ ë° ë£¨í”„] ---
        window.on

