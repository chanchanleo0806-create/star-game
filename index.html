<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Ïä§ÌÉÄ Î©îÏù¥Ïª§: Î≥¥ÏÖÄ ÏõîÎìú</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; color: white; }
        .panel { pointer-events: all; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px; margin: 10px; border: 1px solid #444; }
        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 24px; }
        button { cursor: pointer; background: #3498db; color: white; border: none; padding: 8px; margin: 2px; border-radius: 4px; font-weight: bold; }
        .hidden { display: none !important; }
        #hp-bar { width: 100%; height: 10px; background: #333; margin-top: 5px; }
        #hp-fill { width: 100%; height: 100%; background: #ff4757; transition: 0.2s; }
    </style>
</head>
<body>

<div id="login-screen" style="position:fixed; inset:0; background:#1a1a2e; z-index:100; display:flex; align-items:center; justify-content:center;">
    <div class="panel" style="width:280px; text-align:center; background:white; color:black;">
        <h2 style="margin-top:0">‚õèÔ∏è PIXEL WORLD</h2>
        <input type="text" id="uid" placeholder="ÏïÑÏù¥Îîî" style="width:90%; padding:10px; margin-bottom:5px;">
        <input type="password" id="upw" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" style="width:90%; padding:10px; margin-bottom:15px;">
        <button onclick="handleAuth('login')" style="width:45%">Î°úÍ∑∏Ïù∏</button>
        <button onclick="handleAuth('signup')" style="width:45%; background:#9b59b6">Í∞ÄÏûÖ</button>
    </div>
</div>

<div id="ui" class="hidden">
    <div id="crosshair">+</div>
    <div class="panel" style="width: 220px;">
        <div>üë§ <span id="user-txt">-</span></div>
        <div id="hp-bar"><div id="hp-fill"></div></div>
        <div style="font-size:12px; margin-top:5px;">
            ü™µ:<span id="inv-WOOD">0</span> ü™®:<span id="inv-STONE">0</span> üíé:<span id="inv-DIAMOND">0</span>
        </div>
    </div>
    <div class="panel" style="position:fixed; bottom:20px; right:20px;">
        <button onclick="craft('DIAMOND_SWORD')">üíé Îã§Ïù¥ÏïÑ Í≤Ä Ï†úÏûë</button>
        <button onclick="jump()">Jump (Space)</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC2PE60dAZ-PD440QgploZuoLZckAg6FW0",
        authDomain: "star-edd2c.firebaseapp.com",
        databaseURL: "https://star-edd2c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "star-edd2c",
        storageBucket: "star-edd2c.firebasestorage.app",
        appId: "1:724074828482:web:90001ae0ccdf0d389ce15b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId, myModel, scene, camera, renderer, myData = {};
    let chunks = {}, players = {}, blocks = [];
    const keys = {}, CHUNK_SIZE = 16, NOISE_SCALE = 0.1, HEIGHT_SCALE = 3;
    let vY = 0; // Ï§ëÎ†•/Ï†êÌîÑ ÏÜçÎèÑ

    async function handleAuth(type) {
        const id = document.getElementById('uid').value;
        const pw = document.getElementById('upw').value;
        const ref = db.ref('users/' + id);
        const snap = await ref.once('value');
        if(type === 'signup') {
            if(snap.exists()) return alert("Ï§ëÎ≥µ!");
            await ref.set({pw, WOOD:0, STONE:0, DIAMOND:0, hp:100, weapon:"Îß®ÏÜê"});
            alert("Í∞ÄÏûÖÏôÑÎ£å");
        } else {
            if(snap.exists() && snap.val().pw === pw) { myId = id; start(); }
            else alert("Ï†ïÎ≥¥Î∂àÏùºÏπò");
        }
    }

    function start() {
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('ui').classList.remove('hidden');
        document.getElementById('user-txt').innerText = myId;
        init3D();
        sync();
    }

    function init3D() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        myModel = new THREE.Group();
        const body = new THREE.Mesh(new THREE.BoxGeometry(0.6,0.8,0.3), new THREE.MeshStandardMaterial({color:0x3498db}));
        body.position.y = 0.4;
        myModel.add(body);
        scene.add(myModel);

        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        window.addEventListener('mousedown', onAction);
        animate();
    }

    function getTerrainHeight(x, z) {
        return Math.floor(Math.sin(x * NOISE_SCALE) * Math.cos(z * NOISE_SCALE) * HEIGHT_SCALE);
    }

    function updateChunks() {
        const cx = Math.floor(myModel.position.x / CHUNK_SIZE);
        const cz = Math.floor(myModel.position.z / CHUNK_SIZE);
        for(let x = cx-1; x <= cx+1; x++) {
            for(let z = cz-1; z <= cz+1; z++) {
                if(!chunks[`${x},${z}`]) {
                    const group = new THREE.Group();
                    for(let lx=0; lx<CHUNK_SIZE; lx++){
                        for(let lz=0; lz<CHUNK_SIZE; lz++){
                            const wx = x*CHUNK_SIZE + lx;
                            const wz = z*CHUNK_SIZE + lz;
                            const h = getTerrainHeight(wx, wz);
                            const box = new THREE.Mesh(
                                new THREE.BoxGeometry(1,1,1),
                                new THREE.MeshStandardMaterial({color: h > 1 ? 0x7f8c8d : 0x27ae60})
                            );
                            box.position.set(wx, h - 0.5, wz);
                            box.userData = {type: h > 1 ? 'STONE' : 'WOOD'};
                            group.add(box);
                            blocks.push(box);
                        }
                    }
                    scene.add(group);
                    chunks[`${x},${z}`] = group;
                }
            }
        }
    }

    function jump() { if(vY === 0) vY = 0.2; }

    function onAction() {
        const ray = new THREE.Raycaster();
        ray.setFromCamera(new THREE.Vector2(0,0), camera);
        const hits = ray.intersectObjects(blocks);
        if(hits.length > 0 && hits[0].distance < 5) {
            const type = hits[0].object.userData.type;
            db.ref('users/'+myId+'/'+type).transaction(c => (c||0)+1);
            hits[0].object.visible = false;
        }
    }

    function sync() {
        db.ref('users/'+myId).on('value', s => {
            myData = s.val();
            ['WOOD','STONE','DIAMOND'].forEach(k => document.getElementById('inv-'+k).innerText = myData[k]||0);
            document.getElementById('hp-fill').style.width = (myData.hp || 100) + "%";
        });
        db.ref('live/'+myId).set({x:0, z:0, y:0});
        db.ref('live').on('value', s => {
            const d = s.val();
            for(let id in d) {
                if(id === myId) continue;
                if(!players[id]) {
                    players[id] = new THREE.Mesh(new THREE.BoxGeometry(0.6,1.2,0.3), new THREE.MeshStandardMaterial({color:0xe74c3c}));
                    scene.add(players[id]);
                }
                players[id].position.set(d[id].x, d[id].y, d[id].z);
            }
        });
    }

    window.onkeydown = e => { keys[e.code] = true; if(e.code === 'Space') jump(); };
    window.onkeyup = e => keys[e.code] = false;

    function animate() {
        requestAnimationFrame(animate);
        let speed = 0.15;
        if(keys['KeyW']) myModel.position.z -= speed;
        if(keys['KeyS']) myModel.position.z += speed;
        if(keys['KeyA']) myModel.position.x -= speed;
        if(keys['KeyD']) myModel.position.x += speed;

        // Ï§ëÎ†• Î∞è ÏßÄÌòï Ï∂©Îèå
        const groundY = getTerrainHeight(myModel.position.x, myModel.position.z);
        if(myModel.position.y > groundY) {
            vY -= 0.01; // Ï§ëÎ†•
        } else {
            myModel.position.y = groundY;
            vY = Math.max(0, vY);
        }
        myModel.position.y += vY;

        updateChunks();
        db.ref('live/'+myId).update({x: myModel.position.x, y: myModel.position.y, z: myModel.position.z});
        
        camera.position.lerp(new THREE.Vector3(myModel.position.x, myModel.position.y + 5, myModel.position.z + 8), 0.1);
        camera.lookAt(myModel.position);
        renderer.render(scene, camera);
    }
</script>
</body>
</html>
