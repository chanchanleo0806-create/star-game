<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ENDER REALM APARTMENTS VR</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://threejs.org/examples/js/loaders/GLTFLoader.js"></script> <script src="https://threejs.org/examples/js/controls/PointerLockControls.js"></script> <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; }
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; color: white; }
        .panel { pointer-events: all; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px; margin: 10px; border: 1px solid #7a00ff; box-shadow: 0 0 15px rgba(122,0,255,0.5); }
        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ff00ff; font-size: 28px; text-shadow: 0 0 8px #ff00ff; }
        button { cursor: pointer; background: #4a007a; color: #ff00ff; border: 1px solid #ff00ff; padding: 12px; border-radius: 5px; font-weight: bold; transition: background 0.3s, color 0.3s; }
        button:hover { background: #ff00ff; color: #4a007a; }
        .hidden { display: none !important; }

        /* ëª¨ë°”ì¼ í„°ì¹˜ ì»¨íŠ¸ë¡¤ */
        #mobile-controls { position: fixed; inset: 0; pointer-events: none; z-index: 20; display: flex; justify-content: space-between; align-items: flex-end; }
        #joystick-zone { position: relative; width: 120px; height: 120px; background: rgba(255,255,255,0.08); border-radius: 50%; margin: 25px; pointer-events: all; border: 2px solid rgba(122,0,255,0.4); }
        #joystick-stick { position: absolute; width: 60px; height: 60px; background: #ff00ff; border-radius: 50%; opacity: 0.6; top: 30px; left: 30px; }
        #action-buttons { display: flex; flex-direction: column; gap: 20px; margin: 25px; pointer-events: all; }
        .action-btn { width: 80px; height: 80px; border-radius: 50%; background: rgba(122,0,255,0.3); color: white; font-size: 1.2em; border: 2px solid #ff00ff; }
    </style>
</head>
<body>

<div id="login-screen" style="position:fixed; inset:0; background:#0a000a; z-index:100; display:flex; align-items:center; justify-content:center;">
    <div class="panel" style="width:350px; text-align:center;">
        <h1 style="color:#ff00ff; text-shadow:0 0 20px #ff00ff;">ğŸŒŒ ENDER REALM APARTMENTS ğŸŒŒ</h1>
        <input type="text" id="uid" placeholder="ENDER ID" style="width:90%; padding:15px; margin-bottom:15px; background:#2a002a; border:1px solid #7a00ff; color:#ff00ff; font-size:1.1em;">
        <button onclick="handleAuth()" style="width:100%;">ENTER THE REALM</button>
    </div>
</div>

<div id="ui" class="hidden">
    <div id="crosshair">âœ¦</div>
    <div class="panel" style="align-self: flex-start;">
        <div style="font-size: 1.4em; color: #ff00ff;">ğŸ’° <span id="money-txt">0</span> <small>SHARDS</small></div>
        <div id="status-txt" style="font-size: 1.0em; margin-top: 8px; color: #ff99ff;">ìƒíƒœ: íƒí—˜ ì¤‘</div>
    </div>
</div>

<div id="mobile-controls">
    <div id="joystick-zone">
        <div id="joystick-stick"></div>
    </div>
    <div id="action-buttons">
        <button class="action-btn" onclick="jump()">BOOST</button>
        <button class="action-btn" style="background:rgba(255,0,255,0.3);" onclick="interact()">ACTIVATE</button>
        <button class="action-btn" style="background:rgba(122,0,255,0.3);" onclick="toggleNPC()">DISGUISE</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "YOUR_FIREBASE_API_KEY", // ì‹¤ì œ Firebase API í‚¤ë¡œ êµì²´í•˜ì„¸ìš”.
        authDomain: "YOUR_FIREBASE_PROJECT_ID.firebaseapp.com",
        databaseURL: "https://YOUR_FIREBASE_PROJECT_ID-default-rtdb.asia-southeast1.firebasedatabase.app", // ì‹¤ì œ DB URLë¡œ êµì²´í•˜ì„¸ìš”.
        projectId: "YOUR_FIREBASE_PROJECT_ID",
        storageBucket: "YOUR_FIREBASE_PROJECT_ID.appspot.com",
        appId: "YOUR_FIREBASE_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId, myModel, scene, camera, renderer, controls;
    let players = {}, cars = []; // ë©€í‹°í”Œë ˆì´ì–´ ë° ì°¨ëŸ‰ì€ GTA ì»¨ì…‰ ìœ ì§€
    let touchX = 0, touchY = 0, vY = 0, isNPC = false, drivingCar = null;
    let apartmentBuildings = []; // ì•„íŒŒíŠ¸ ë‚´ë¶€ êµ¬ì¡°ë¥¼ í¬í•¨í•  ë°°ì—´

    // í…ìŠ¤ì²˜ ë¡œë”
    const textureLoader = new THREE.TextureLoader();
    const gltfLoader = new THREE.GLTFLoader();

    // ------------------- UI ë° ë¡œê·¸ì¸/ë™ê¸°í™” ë¡œì§ (ì´ì „ ë²„ì „ê³¼ ìœ ì‚¬) -------------------
    async function handleAuth() {
        myId = document.getElementById('uid').value.trim();
        if(!myId) return alert("ì—”ë” IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
        
        // Firebaseì— ìœ ì € ë°ì´í„° ì €ì¥ ë° ë¡œë“œ
        const userRef = db.ref('users/' + myId);
        const snapshot = await userRef.once('value');
        if (!snapshot.exists()) {
            await userRef.set({ money: 1000, isNPC: false, x: 0, y: 1.7, z: 0 });
            alert("ìƒˆë¡œìš´ íƒí—˜ê°€ ë“±ë¡!");
        }
        
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('ui').classList.remove('hidden');
        init3D();
        sync();
    }

    function sync() {
        // ë‚´ ìƒíƒœ (ìœ„ì¹˜, NPC ì—¬ë¶€, ìš´ì „ ì—¬ë¶€) ì‹¤ì‹œê°„ ì „ì†¡
        setInterval(() => {
            db.ref('live/' + myId).update({
                x: myModel.position.x, y: myModel.position.y, z: myModel.position.z,
                rotY: camera.rotation.y, rotX: camera.rotation.x,
                isNPC: isNPC, isDriving: !!drivingCar
            });
        }, 50);

        // ë‹¤ë¥¸ í”Œë ˆì´ì–´ ìƒíƒœ ë™ê¸°í™”
        db.ref('live').on('value', snapshot => {
            const data = snapshot.val();
            for (let id in data) {
                if (id === myId) continue;
                if (!players[id]) {
                    // ë‹¤ë¥¸ í”Œë ˆì´ì–´ ì•„ë°”íƒ€ (ì—”ë”ì›”ë“œ í†¤ìœ¼ë¡œ ë³€ê²½)
                    players[id] = new THREE.Mesh(
                        new THREE.BoxGeometry(0.5, 1.7, 0.5),
                        new THREE.MeshStandardMaterial({ color: data[id].isNPC ? 0x9900ff : 0x00ffff }) // NPCë©´ ë³´ë¼ìƒ‰, ì¼ë°˜ì´ë©´ ì²­ë¡ìƒ‰
                    );
                    scene.add(players[id]);
                }
                players[id].position.set(data[id].x, data[id].y, data[id].z);
                players[id].rotation.y = data[id].rotY;
                players[id].visible = !data[id].isDriving; // ìš´ì „ ì¤‘ì´ë©´ ì•„ë°”íƒ€ ìˆ¨ê¹€
            }
        });

        // ì°¨ëŸ‰ ìƒíƒœ ë™ê¸°í™”
        db.ref('cars').on('value', snapshot => {
            const data = snapshot.val();
            if (!data) return;
            cars.forEach(car => {
                if (data[car.id] && data[car.id].driver !== myId && data[car.id].x !== undefined) {
                    car.mesh.position.set(data[car.id].x, data[car.id].y, data[car.id].z);
                    car.mesh.rotation.y = data[car.id].rotY;
                }
            });
        });
    }

    // ------------------- 3D í™˜ê²½ ì´ˆê¸°í™” ë° ì—”ë”ì›”ë“œ/ì•„íŒŒíŠ¸ ìƒì„± ë¡œì§ -------------------
    function init3D() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050005); // ì—”ë”ì›”ë“œ ë°°ê²½ìƒ‰
        scene.fog = new THREE.FogExp2(0x050005, 0.015); // ì—”ë”ì›”ë“œ ì•ˆê°œ íš¨ê³¼

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.7, 0); // 1ì¸ì¹­ ì‹œì‘ ìœ„ì¹˜
        camera.rotation.order = 'YXZ'; // ìƒí•˜ íšŒì „ì‹œ X, ì¢Œìš° íšŒì „ì‹œ Y

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio); // ê³ í•´ìƒë„ ë Œë”ë§
        renderer.shadowMap.enabled = true; // ê·¸ë¦¼ì í™œì„±í™”
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; // ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì
        document.body.appendChild(renderer.domElement);

        // 1ì¸ì¹­ ì»¨íŠ¸ë¡¤
        controls = new THREE.PointerLockControls(camera, document.body);
        scene.add(controls.getObject());

        // ë§ˆìš°ìŠ¤ë¡œ ì‹œì  ì œì–´
        document.addEventListener('click', () => controls.lock());
        document.addEventListener('mousemove', (e) => {
            if (controls.isLocked) {
                // PointerLockControlsê°€ ìë™ìœ¼ë¡œ ì¹´ë©”ë¼ rotationì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                // í•„ìš”í•œ ê²½ìš° myModel.rotation.yë¥¼ controls.getObject().rotation.yì— ë™ê¸°í™”.
            }
        });

        // ì¡°ëª… (ì—”ë”ì›”ë“œ ê°ì„±)
        const light = new THREE.PointLight(0xaa00ff, 3, 100); // ë³´ë¼ìƒ‰ í¬ì¸íŠ¸ ë¼ì´íŠ¸
        light.position.set(0, 20, 0);
        light.castShadow = true;
        scene.add(light, new THREE.AmbientLight(0x7a00ff, 0.2)); // ë³´ë¼ìƒ‰ ì£¼ë³€ê´‘

        // ì—”ë”ì›”ë“œ ì§€í˜• (PBR í…ìŠ¤ì²˜ ì ìš©)
        const endStoneTexture = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/hardwood2_diffuse.jpg'); // ì—”ë”ìŠ¤í†¤ ëŒ€ì²´ í…ìŠ¤ì²˜
        const endStoneNormal = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/hardwood2_normal.jpg');
        const endStoneRoughness = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/hardwood2_roughness.jpg');

        const endIsland = new THREE.Mesh(
            new THREE.CylinderGeometry(150, 120, 30, 64),
            new THREE.MeshStandardMaterial({
                map: endStoneTexture,
                normalMap: endStoneNormal,
                roughnessMap: endStoneRoughness,
                color: 0xdfdf9f // ì—”ë”ìŠ¤í†¤ ë² ì´ìŠ¤ ì»¬ëŸ¬
            })
        );
        endIsland.position.y = -15;
        endIsland.receiveShadow = true;
        scene.add(endIsland);

        // ì—”ë” íŒŒí‹°í´ ì‹œìŠ¤í…œ
        createEnderParticles();

        // ì•„íŒŒíŠ¸ ê±´ë¬¼ ì—¬ëŸ¬ ê°œ ìƒì„±
        for (let i = 0; i < 5; i++) {
            const x = (Math.random() - 0.5) * 200;
            const z = (Math.random() - 0.5) * 200;
            spawnApartment(x, z);
        }

        // ì°¨ëŸ‰ ì—¬ëŸ¬ ëŒ€ ìƒì„±
        for (let i = 0; i < 10; i++) {
            spawnCar('car_' + i);
        }

        animate();
    }

    // ì—”ë” íŒŒí‹°í´ ìƒì„±
    function createEnderParticles() {
        const particleCount = 1000;
        const particles = new THREE.BufferGeometry();
        const positions = [];
        const colors = [];

        for (let i = 0; i < particleCount; i++) {
            // ë„“ì€ ê³µê°„ì— í©ë¿Œë ¤ì§„ íŒŒí‹°í´
            positions.push((Math.random() - 0.5) * 500);
            positions.push((Math.random() - 0.5) * 200);
            positions.push((Math.random() - 0.5) * 500);

            // ë³´ë¼ìƒ‰ ê³„ì—´ ìƒ‰ìƒ
            colors.push(0.5 + Math.random() * 0.5); // R (ì–´ë‘¡ê²Œ)
            colors.push(0); // G (ì´ˆë¡ìƒ‰ ë°°ì œ)
            colors.push(0.5 + Math.random() * 0.5); // B (ë³´ë¼ìƒ‰ ê°•ì¡°)
        }
        particles.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        particles.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

        const particleMaterial = new THREE.PointsMaterial({
            size: 0.5,
            vertexColors: true,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending // ë°ê²Œ ë¹›ë‚˜ëŠ” íš¨ê³¼
        });
        const particleSystem = new THREE.Points(particles, particleMaterial);
        scene.add(particleSystem);
    }

    // ì•„íŒŒíŠ¸ ê±´ë¬¼ ìƒì„± (ë‚´ë¶€ êµ¬ì¡° í¬í•¨)
    function spawnApartment(x, z) {
        const aptGroup = new THREE.Group();
        const floorHeight = 4; // í•œ ì¸µ ë†’ì´
        const numFloors = 10; // ì´ ì¸µìˆ˜
        const aptWidth = 20; // ì•„íŒŒíŠ¸ ê°€ë¡œì„¸ë¡œ ê¸¸ì´
        const corridorWidth = 4; // ë³µë„ í­

        const wallTexture = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/brick_diffuse.jpg'); // ë²½ëŒ í…ìŠ¤ì²˜
        const floorTexture = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/tiles.jpg'); // íƒ€ì¼ í…ìŠ¤ì²˜

        for (let f = 0; f < numFloors; f++) {
            const currentY = f * floorHeight;

            // ë°”ë‹¥ (PBR íƒ€ì¼ í…ìŠ¤ì²˜)
            const floorGeo = new THREE.BoxGeometry(aptWidth, 0.1, aptWidth);
            const floorMat = new THREE.MeshStandardMaterial({ map: floorTexture, roughness: 0.8 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.position.y = currentY;
            floor.receiveShadow = true;
            aptGroup.add(floor);

            // ì™¸ë¶€ ë²½ (PBR ë²½ëŒ í…ìŠ¤ì²˜)
            const outerWallMat = new THREE.MeshStandardMaterial({ map: wallTexture, roughness: 0.6 });
            const outerWall1 = new THREE.Mesh(new THREE.BoxGeometry(aptWidth, floorHeight, 0.2), outerWallMat);
            outerWall1.position.set(0, currentY + floorHeight / 2, aptWidth / 2); // ì• ë²½
            aptGroup.add(outerWall1);
            const outerWall2 = new THREE.Mesh(new THREE.BoxGeometry(aptWidth, floorHeight, 0.2), outerWallMat);
            outerWall2.position.set(0, currentY + floorHeight / 2, -aptWidth / 2); // ë’¤ ë²½
            aptGroup.add(outerWall2);
            const outerWall3 = new THREE.Mesh(new THREE.BoxGeometry(0.2, floorHeight, aptWidth), outerWallMat);
            outerWall3.position.set(aptWidth / 2, currentY + floorHeight / 2, 0); // ì˜¤ë¥¸ìª½ ë²½
            aptGroup.add(outerWall3);

            // ë‚´ë¶€ ë³µë„ ë²½ (ê°€ìš´ë° ëš«ë¦° ë³µë„)
            const corridorWall1 = new THREE.Mesh(new THREE.BoxGeometry(0.2, floorHeight, (aptWidth - corridorWidth) / 2), outerWallMat);
            corridorWall1.position.set(-aptWidth / 2, currentY + floorHeight / 2, -(aptWidth + corridorWidth) / 4);
            aptGroup.add(corridorWall1);
            const corridorWall2 = new THREE.Mesh(new THREE.BoxGeometry(0.2, floorHeight, (aptWidth - corridorWidth) / 2), outerWallMat);
            corridorWall2.position.set(-aptWidth / 2, currentY + floorHeight / 2, (aptWidth + corridorWidth) / 4);
            aptGroup.add(corridorWall2);

            // ë³µë„ ì²œì¥ ì¡°ëª… (ì—”ë”ì›”ë“œ ê°ì„± ë³´ë¼ìƒ‰)
            const ceilingLight = new THREE.PointLight(0xbc
