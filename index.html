<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìŠ¤íƒ€ ë©”ì´ì»¤: ì •ì‹ ì„œë¹„ìŠ¤ ë²„ì „</title>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #87CEEB; font-family: 'Malgun Gothic', sans-serif; overflow: hidden; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        .panel { pointer-events: all; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; color: white; border: 1px solid #444; }
        
        /* ë¡œê·¸ì¸/ê°€ì… í™”ë©´ */
        #login-screen { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: #1a1a2e; z-index: 100; }
        .login-box { background: white; padding: 30px; border-radius: 15px; text-align: center; width: 300px; }
        
        /* ì±„íŒ… ë° ë©”ë‰´ */
        #chat-area { position: absolute; bottom: 20px; left: 20px; width: 300px; }
        #messages { height: 100px; overflow-y: auto; font-size: 13px; margin-bottom: 5px; background: rgba(0,0,0,0.3); }
        #status-bar { position: absolute; top: 20px; left: 20px; }
        
        input, button { padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin: 5px; width: 90%; }
        button { background: #3498db; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:hover { background: #2980b9; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h1 style="color: #1a1a2e;">â­ STAR MAKER</h1>
            <input type="text" id="uid" placeholder="ë‹‰ë„¤ì„">
            <input type="password" id="upw" placeholder="ë¹„ë°€ë²ˆí˜¸">
            <button onclick="handleAuth('login')" style="background: #2ecc71;">ë¡œê·¸ì¸</button>
            <button onclick="handleAuth('signup')" style="background: #9b59b6;">íšŒì›ê°€ì…</button>
        </div>
    </div>

    <div id="ui-layer" class="hidden">
        <div id="status-bar" class="panel">
            <div>ğŸ‘¤ ì ‘ì†: <span id="user-txt">-</span></div>
            <div>ğŸ›ï¸ êµ­ê°€: <span id="country-txt">ë¬´ì†Œì†</span></div>
        </div>
        <div id="chat-area" class="panel">
            <div id="messages"></div>
            <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." style="width: 70%;">
            <button onclick="sendChat()" style="width: 20%;">ì „ì†¡</button>
        </div>
    </div>

    <script>
        // --- [Firebase ì„¤ì •] ---
        const firebaseConfig = {
            apiKey: "AIzaSyC2PE60dAZ-PD440QgploZuoLZckAg6FW0",
            authDomain: "star-edd2c.firebaseapp.com",
            databaseURL: "https://star-edd2c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "star-edd2c.firebaseapp.com",
            storageBucket: "star-edd2c.firebasestorage.app",
            appId: "1:724074828482:web:90001ae0ccdf0d389ce15b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myId, myModel, scene, camera, renderer;
        let players = {};
        const keys = {};

        // --- [íšŒì›ê°€ì… & ë¡œê·¸ì¸ ê¸°ëŠ¥] ---
        async function handleAuth(type) {
            const id = document.getElementById('uid').value;
            const pw = document.getElementById('upw').value;
            if(!id || !pw) return alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!");

            const userRef = db.ref('users/' + id);
            const snap = await userRef.once('value');

            if(type === 'signup') {
                if(snap.exists()) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤.");
                await userRef.set({ pw: pw, country: "ë¬´ì†Œì†", x: 0, z: 0 });
                alert("íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”.");
            } else {
                if(snap.val() && snap.val().pw === pw) {
                    myId = id;
                    startGame();
                } else {
                    alert("ì •ë³´ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
                }
            }
        }

        function startGame() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('hidden');
            document.getElementById('user-txt').innerText = myId;
            init3D();
            syncData();
        }

        // --- [3D ì›”ë“œ] ---
        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // ì”ë””ë°­ & ê²©ì
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0x27ae60 }));
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor, new THREE.GridHelper(100, 50));

            // ë‚´ ìºë¦­í„° (ì‚¬ëŒ ëª¨ì–‘)
            myModel = createHuman(0x3498db);
            scene.add(myModel);

            scene.add(new THREE.AmbientLight(0xffffff, 0.8));
            camera.position.set(0, 5, 10);
            animate();
        }

        function createHuman(color) {
            const group = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.8, 0.3), new THREE.MeshStandardMaterial({color: color}));
            body.position.y = 0.4;
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), new THREE.MeshStandardMaterial({color: 0xffdbac}));
            head.position.y = 1.0;
            group.add(body, head);
            return group;
        }

        // --- [ë°ì´í„° ë™ê¸°í™”] ---
        function syncData() {
            db.ref('live_players/' + myId).set({ x: 0, z: 0 });
            db.ref('live_players').on('value', (snap) => {
                const data = snap.val();
                for(let id in data) {
                    if(id === myId) continue;
                    if(!players[id]) {
                        players[id] = createHuman(0xe74c3c);
                        scene.add(players[id]);
                    }
                    players[id].position.set(data[id].x, 0, data[id].z);
                }
            });
            db.ref('chats').limitToLast(10).on('child_added', (snap) => {
                const c = snap.val();
                document.getElementById('messages').innerHTML += `<div><b>${c.u}:</b> ${c.m}</div>`;
                document.getElementById('messages').scrollTop = 9999;
            });
        }

        // --- [ì¡°ì‘] ---
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        function animate() {
            requestAnimationFrame(animate);
            let move = false;
            if(keys['ArrowUp'] || keys['KeyW']) { myModel.position.z -= 0.1; move = true; }
            if(keys['ArrowDown'] || keys['KeyS']) { myModel.position.z += 0.1; move = true; }
            if(keys['ArrowLeft'] || keys['KeyA']) { myModel.position.x -= 0.1; move = true; }
            if(keys['ArrowRight'] || keys['KeyD']) { myModel.position.x += 0.1; move = true; }

            if(move) {
                db.ref('live_players/' + myId).update({ x: myModel.position.x, z: myModel.position.z });
                camera.position.lerp(new THREE.Vector3(myModel.position.x, 5, myModel.position.z + 7), 0.1);
                camera.lookAt(myModel.position);
            }
            renderer.render(scene, camera);
        }

        function sendChat() {
            const i = document.getElementById('chat-input');
            if(i.value) { db.ref('chats').push({ u: myId, m: i.value }); i.value = ""; }
        }
    </script>
</body>
</html>
