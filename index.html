<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PIXEL GTA MULTI</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; touch-action: none; }
        #ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; color: white; }
        .panel { pointer-events: all; background: rgba(0,0,0,0.8); padding: 15px; border: 2px solid #444; margin: 10px; }
        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #0f0; font-size: 24px; }
        button { cursor: pointer; background: #222; color: #0f0; border: 1px solid #0f0; padding: 10px; font-weight: bold; }
        .hidden { display: none !important; }
        
        /* Ïª®Ìä∏Î°§ UI */
        #joystick { position: fixed; bottom: 40px; left: 40px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; pointer-events: all; }
        #stick { position: absolute; top: 25px; left: 25px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.5; }
        #btns { position: fixed; bottom: 40px; right: 40px; pointer-events: all; display: flex; flex-direction: column; gap: 10px; }
        .circle-btn { width: 70px; height: 70px; border-radius: 50%; background: rgba(0,0,0,0.6); border: 2px solid #0f0; color: white; font-size: 10px; }
    </style>
</head>
<body>

<div id="login-screen" style="position:fixed; inset:0; background:#111; z-index:100; display:flex; align-items:center; justify-content:center;">
    <div class="panel" style="width:280px; text-align:center;">
        <h1 style="color:#0f0;">PIXEL GTA MULTI</h1>
        <input type="text" id="uid" placeholder="ID" style="width:90%; padding:10px; margin-bottom:10px; background:#000; color:#0f0; border:1px solid #0f0;">
        <button onclick="handleAuth()" style="width:100%">ÎèÑÏãú ÏûÖÏû•</button>
    </div>
</div>

<div id="ui" class="hidden">
    <div id="crosshair">+</div>
    <div class="panel" style="width: 200px;">
        <div>üí∞ <span id="money-txt">0</span></div>
        <div id="status-txt" style="color:#f1c40f; font-size:12px; margin-top:5px;">ÏÉÅÌÉú: Î≥¥ÌñâÏûê</div>
    </div>
    <div id="joystick"><div id="stick"></div></div>
    <div id="btns">
        <button class="circle-btn" onclick="jump()">BOOST</button>
        <button class="circle-btn" style="border-color:#f1c40f;" onclick="interact()">STEAL/EXIT</button>
        <button class="circle-btn" style="border-color:#e74c3c;" onclick="toggleNPC()">NPC MODE</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC2PE60dAZ-PD440QgploZuoLZckAg6FW0",
        authDomain: "star-edd2c.firebaseapp.com",
        databaseURL: "https://star-edd2c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "star-edd2c",
        storageBucket: "star-edd2c.firebasestorage.app",
        appId: "1:724074828482:web:90001ae0ccdf0d389ce15b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId, myModel, scene, camera, renderer, myData = {};
    let cars = [], players = {}, blocks = [];
    let touchX = 0, touchY = 0, vY = 0, isNPC = false, drivingCar = null;

    function handleAuth() {
        myId = document.getElementById('uid').value.trim();
        if(!myId) return alert("ID ÏûÖÎ†•!");
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('ui').classList.remove('hidden');
        init3D();
        sync();
    }

    function init3D() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0a);
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.rotation.order = 'YXZ';
        
        renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        myModel = new THREE.Group();
        scene.add(myModel);
        scene.add(new THREE.AmbientLight(0xffffff, 0.6), new THREE.DirectionalLight(0xffffff, 0.8));

        // ÎßàÏö∞Ïä§ Í∞êÎèÑ Î∞è Ï°∞Ïù¥Ïä§Ìã± Î°úÏßÅ (ÏÉùÎûµ - Ïù¥Ï†Ñ Î≤ÑÏ†ÑÍ≥º ÎèôÏùº)
        renderer.domElement.addEventListener('click', () => renderer.domElement.requestPointerLock());
        document.addEventListener('mousemove', (e) => {
            if (document.pointerLockElement === renderer.domElement) {
                myModel.rotation.y -= e.movementX * 0.003;
                camera.rotation.x -= e.movementY * 0.003;
                camera.rotation.x = Math.max(-Math.PI/2, Math.min(Math.PI/2, camera.rotation.x));
            }
        });

        // Ï°∞Ïù¥Ïä§Ìã±
        const zone = document.getElementById('joystick');
        const stick = document.getElementById('stick');
        zone.addEventListener('touchmove', (e) => {
            const rect = zone.getBoundingClientRect();
            let dx = e.touches[0].clientX - (rect.left + 50), dy = e.touches[0].clientY - (rect.top + 50);
            const d = Math.sqrt(dx*dx+dy*dy);
            if(d > 40) { dx *= 40/d; dy *= 40/d; }
            stick.style.transform = `translate(${dx}px, ${dy}px)`;
            touchX = dx/40; touchY = dy/40;
        });
        zone.addEventListener('touchend', () => { stick.style.transform = 'translate(0,0)'; touchX=0; touchY=0; });

        createCity();
        animate();
    }

    function createCity() {
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshStandardMaterial({color: 0x111111}));
        floor.rotation.x = -Math.PI/2;
        scene.add(floor);

        // Í±¥Î¨º Î∞è Ï∞®Îüâ ÏÉùÏÑ±
        for(let i=0; i<40; i++) {
            const h = 5 + Math.random()*20;
            const b = new THREE.Mesh(new THREE.BoxGeometry(4, h, 4), new THREE.MeshStandardMaterial({color: 0x222222}));
            b.position.set((Math.random()-0.5)*150, h/2, (Math.random()-0.5)*150);
            scene.add(b);
        }
        
        for(let i=0; i<15; i++) {
            const car = new THREE.Mesh(new THREE.BoxGeometry(2, 1, 4), new THREE.MeshStandardMaterial({color: Math.random()*0xffffff}));
            car.position.set((Math.random()-0.5)*100, 0.5, (Math.random()-0.5)*100);
            const carObj = { id: 'car_'+i, mesh: car, driver: null };
            scene.add(car);
            cars.push(carObj);
        }
    }

    function interact() {
        if(drivingCar) {
            db.ref('cars/'+drivingCar.id).update({ driver: null });
            drivingCar = null;
            document.getElementById('status-txt').innerText = "ÏÉÅÌÉú: Î≥¥ÌñâÏûê";
            return;
        }
        cars.forEach(c => {
            if(c.mesh.position.distanceTo(myModel.position) < 5) {
                db.ref('cars/'+c.id).once('value', s => {
                    if(!s.val() || !s.val().driver) {
                        db.ref('cars/'+c.id).update({ driver: myId });
                        drivingCar = c;
                        isNPC = false;
                        document.getElementById('status-txt').innerText = "ÏÉÅÌÉú: Ïö¥Ï†Ñ Ï§ë";
                    } else { alert("ÎàÑÍµ∞Í∞Ä ÌÉÄÍ≥† ÏûàÏäµÎãàÎã§!"); }
                });
            }
        });
    }

    function toggleNPC() {
        if(drivingCar) return alert("Ïö¥Ï†Ñ Ï§ëÏóêÎäî Î≥ÄÏû•Ìï† Ïàò ÏóÜÏäµÎãàÎã§!");
        isNPC = !isNPC;
        document.getElementById('status-txt').innerText = isNPC ? "ÏÉÅÌÉú: NPC Î≥ÄÏû•" : "ÏÉÅÌÉú: Î≥¥ÌñâÏûê";
    }

    function jump() { if(vY === 0) vY = 0.2; }

    function sync() {
        // ÎÇ¥ ÏÉÅÌÉú Ï†ÑÏÜ°
        setInterval(() => {
            db.ref('live/'+myId).update({
                x: myModel.position.x, y: myModel.position.y, z: myModel.position.z,
                rot: myModel.rotation.y, isNPC: isNPC, isDriving: !!drivingCar
            });
        }, 50);

        // Îã§Î•∏ Ïú†Ï†Ä ÎèôÍ∏∞Ìôî
        db.ref('live').on('value', s => {
            const d = s.val();
            for(let id in d) {
                if(id === myId) continue;
                if(!players[id]) {
                    players[id] = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1, 0.5), new THREE.MeshStandardMaterial());
                    scene.add(players[id]);
                }
                players[id].position.set(d[id].x, d[id].y + 0.5, d[id].z);
                players[id].rotation.y = d[id].rot;
                players[id].material.color.setHex(d[id].isNPC ? 0xffff00 : 0xff0000);
                players[id].visible = !d[id].isDriving; // Ï∞® ÌÉÄÍ≥† ÏûàÏúºÎ©¥ Î™®Îç∏ Ïà®ÍπÄ
            }
        });

        // Ï∞®Îüâ ÏúÑÏπò ÎèôÍ∏∞Ìôî (ÎÇ¥Í∞Ä Ïö¥Ï†ÑÌï† ÎïåÎßå Ï†ÑÏÜ°)
        db.ref('cars').on('value', s => {
            const d = s.val();
            if(!d) return;
            cars.forEach(c => {
                if(d[c.id] && d[c.id].driver !== myId && d[c.id].x !== undefined) {
                    c.mesh.position.set(d[c.id].x, 0.5, d[c.id].z);
                    c.mesh.rotation.y = d[c.id].rot;
                }
            });
        });
    }

    function animate() {
        requestAnimationFrame(animate);
        const speed = drivingCar ? 0.6 : 0.15;
        const dir = new THREE.Vector3();
        myModel.getWorldDirection(dir);
        
        // Ïù¥Îèô
        if(touchY < -0.2) myModel.position.addScaledVector(dir, speed);
        if(touchY > 0.2) myModel.position.addScaledVector(dir, -speed);
        if(drivingCar && Math.abs(touchX) > 0.2) drivingCar.mesh.rotation.y -= touchX * 0.05;

        if(drivingCar) {
            drivingCar.mesh.position.copy(myModel.position);
            drivingCar.mesh.rotation.y = myModel.rotation.y;
            db.ref('cars/'+drivingCar.id).update({
                x: drivingCar.mesh.position.x, z: drivingCar.mesh.position.z, rot: drivingCar.mesh.rotation.y
            });
        }

        // Ï§ëÎ†•
        if(myModel.position.y > 0) vY -= 0.01;
        else { myModel.position.y = 0; vY = Math.max(0, vY); }
        myModel.position.y += vY;

        // 1Ïù∏Ïπ≠ Ïπ¥Î©îÎùº
        camera.position.set(myModel.position.x, myModel.position.y + 1.7, myModel.position.z);
        camera.rotation.y = myModel.rotation.y;

        renderer.render(scene, camera);
    }
</script>
</body>
</html>
